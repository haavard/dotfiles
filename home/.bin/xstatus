#!/usr/bin/env bash
# xstatus -- daemon for setting the X root window name
set -o errexit
set -o nounset

update_file=$(mktemp)
temp_file=$(mktemp)
trap "rm '$update_file' '$temp_file'" EXIT

( while :; do
    # if checkupdates >"$temp_file" && aurupdate -l ~/aur >>"$temp_file"; then
    if checkupdates >"$temp_file"; then
        cat "$temp_file" >"$update_file"
    fi
    sleep 900
done ) &

while :; do
    wifi=$(iw dev | grep ssid | sed 's/\s*ssid\s//')
    if [ -z "$wifi" ]; then
        wifi='Disconnected'
    fi

    if pidof openvpn >/dev/null; then
        wifi="$wifi (VPN)"
    fi

    battery=$(acpi --battery | sed 's/Battery 0: //g')
    date=$(date '+%a (W%V) %Y-%m-%d %H:%M')

    update_count=$(wc -l <"$update_file")
    if [ "$update_count" = 0 ]; then
        xsetroot -name "$wifi | $battery | $date"
    else
        xsetroot -name "$update_count update(s) | $wifi | $battery | $date"
    fi

    sleep 5
done
